{% extends "base.html" %}

{% block title %}Página Principal{% endblock %}

{% block content %}
<!-- Botón para abrir el panel -->
<button id="toggleFilters" class="bg-blue-600 text-white px-4 py-2 rounded">Filtrar por palabras clave</button>

<!-- Panel de filtros -->

<div id="filterPanel" class="mt-4 w-64 bg-gray-800 text-white rounded p-4 shadow hidden">
    <div class="flex justify-between items-center mb-2">
        <h2 class="font-bold">Filtros</h2>
        <div class="space-x-2">
            <button id="saveView" class="text-blue-400 hover:underline">Filtrar</button>
        </div>
    </div>

    <!-- Fecha exacta -->
    <div class="mt-4">
        <label class="block font-semibold mb-1" for="fecha">Fecha:</label>
        <input type="date" id="fecha" name="fecha"
            class="w-full bg-gray-700 text-white border border-gray-600 rounded px-2 py-1">
    </div>

    <!-- Rango de fechas -->
    <div class="mt-4">
        <label class="block font-semibold mb-1">Rango de fechas:</label>
        <div class="flex gap-2">
            <input type="date" id="fechaInicio" name="fechaInicio"
                class="w-1/2 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1">
            <input type="date" id="fechaFin" name="fechaFin"
                class="w-1/2 bg-gray-700 text-white border border-gray-600 rounded px-2 py-1">
        </div>
    </div>

    <!-- Hora -->
    <div class="mt-4">
        <label class="block font-semibold mb-1" for="hora">Hora:</label>
        <input type="time" id="hora" name="hora"
            class="w-full bg-gray-700 text-white border border-gray-600 rounded px-2 py-1">
    </div>
    <div>
        <button id="toggleCategory" class="w-full text-left font-semibold flex justify-between items-center">
            Categoría
            <span id="arrow" class="transition-transform">&#9662;</span>
        </button>
        <div id="categoryList" class="mt-2 space-y-1 hidden">
            <!-- ... otros elementos -->
        </div>
    </div>

</div>
<select id="categoriaSelect" name="tipo" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
    <option value="por defecto">
        Seleccione una opsion</option>
    <option value="apache_access" {% if tipo_seleccionado=='apache_access' %}selected{% endif %}>
        Apache access</option>
    <option value="apache_error" {% if tipo_seleccionado=='apache_error' %}selected{% endif %}>
        Apache error</option>
    <option value="ftp" {% if tipo_seleccionado=='ftp' %}selected{% endif %}>FTP</option>
</select>

<table id="tabla-logs" class="w-full text-xs text-left text-gray-600">
    <thead>
        <tr id="tabla-header"></tr>
    </thead>
    <tbody id="tabla-body"></tbody>
</table>

<!-- Script clásico -->
<script>
    const toggleFilters = document.getElementById("toggleFilters");
    const filterPanel = document.getElementById("filterPanel");
    const toggleCategory = document.getElementById("toggleCategory");
    const categoryList = document.getElementById("categoryList");
    const arrow = document.getElementById("arrow");
    const saveView = document.getElementById("saveView");

    toggleFilters.addEventListener("click", () => {
        filterPanel.classList.toggle("hidden");
    });

    toggleCategory.addEventListener("click", () => {
        categoryList.classList.toggle("hidden");
        arrow.classList.toggle("rotate-180");
    });

    saveView.addEventListener("click", () => {
        filterPanel.classList.add("hidden");
    });

    function agruparPorCategoria(diccionario, valoresArray) {
        const resultado = {};

        for (const valor of valoresArray) {
            for (const [categoria, valores] of Object.entries(diccionario)) {
                if (valores.includes(valor)) {
                    if (!resultado[categoria]) {
                        resultado[categoria] = [];
                    }
                    resultado[categoria].push(valor);
                    break; // rompe para evitar duplicados en varias categorías
                }
            }
        }

        return resultado;
    }



    document.getElementById('categoriaSelect').addEventListener('change', function () {
        const categoriaId = this.value;
        const categoryList = document.getElementById('categoryList');
        const select = document.getElementById('categoriaSelect');
        const valor = select.value; // Obtiene el valor del <option> seleccionado
        console.log(valor);
        categoryList.innerHTML = ''; // Limpiar contenido previo
        if (valor === 'apache_access') {
            const categorias_access = ['Solicitud', 'Codigo Estado', 'Navegador'];
            const categoria_solicitud = ['GET', 'POST', 'DELETE', 'OPTIONS'];
            const categoria_codigo_estado = ['404', '403', '500', '503'];
            const categoria_navegador = ['Chrome', 'Edge', 'Firefox', 'Safari', 'Opera', 'Internet Explorer'];
            categorias_access.forEach((categoria, index) => {
                // Crear título de categoría
                const title = document.createElement('div');
                title.className = 'font-medium mt-2 flex ';
                title.textContent = categoria;
                categoryList.appendChild(title);

                // Obtener subcategorías según índice
                let subcategorias = [];
                if (index === 0) subcategorias = categoria_solicitud;
                else if (index === 1) subcategorias = categoria_codigo_estado;
                else if (index === 2) subcategorias = categoria_navegador;

                // Crear checkboxes
                subcategorias.forEach(sub => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center justify-start space-x-2 px-2';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `filtro_${categoria.toLowerCase().replace(' ', '_')}`;
                    checkbox.value = sub;

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(sub));
                    categoryList.appendChild(label);
                });
            });

        } else if (valor === 'apache_error') {
            const categorias_error = ['Nivel', 'Modulo'];
            const categoria_nivel = ['emerg', 'alert', 'crit', 'error', 'warn', 'notice', 'info', 'debug', 'access_compat'];
            const categoria_modulo = ['core', 'ssl', 'authz_core', 'rewrite', 'php7', 'php8', 'mpm_prefork', 'proxy'];

            categorias_error.forEach((categoria, index) => {
                // Crear título de categoría
                const title = document.createElement('div');
                title.className = 'font-medium mt-2 flex ';
                title.textContent = categoria;
                categoryList.appendChild(title);

                // Obtener subcategorías según índice
                let subcategorias = [];
                if (index === 0) subcategorias = categoria_nivel;
                else if (index === 1) subcategorias = categoria_modulo;

                // Crear checkboxes
                subcategorias.forEach(sub => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center justify-start space-x-2 px-2';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `filtro_${categoria.toLowerCase().replace(' ', '_')}`;
                    checkbox.value = sub;

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(sub));
                    categoryList.appendChild(label);
                });
            });

        } else if (valor === 'ftp') {
            const categorias_ftp = ['Tipo accion'];
            const categoria_accion = ['FTP command', 'FTP response', 'FAIL LOGIN', 'CONNECTED', 'OK LOGIN', 'FAIL DOWNLOAD', 'DENIED'];
            categorias_ftp.forEach((categoria, index) => {
                // Crear título de categoría
                const title = document.createElement('div');
                title.className = 'font-medium mt-2 flex ';
                title.textContent = categoria;
                categoryList.appendChild(title);

                // Obtener subcategorías según índice
                let subcategorias = [];
                if (index === 0) subcategorias = categoria_accion;

                // Crear checkboxes
                subcategorias.forEach(sub => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center justify-start space-x-2 px-2';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `filtro_${categoria.toLowerCase().replace(' ', '_')}`;
                    checkbox.value = sub;

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(sub));
                    categoryList.appendChild(label);
                });
            });

        }



    });

    document.getElementById('saveView').addEventListener('click', () => {


        // Obtener fecha exacta
        const fecha = document.getElementById('fecha').value;
        const select_categoria = document.getElementById('categoriaSelect').value;
        // Obtener rango de fechas
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;

        // Obtener hora
        const hora = document.getElementById('hora').value;
        let categorias_selecionadas = {};
        // Obtener categorías seleccionadas
        const categoriasSeleccionadas = [];
        document.querySelectorAll('#categoryList input[type="checkbox"]:checked').forEach(cb => {
            categoriasSeleccionadas.push(cb.parentElement.textContent.trim());
        });
        if (select_categoria === 'apache_access') {
            const categorias_access = {
                'Solicitud': ['GET', 'POST', 'DELETE', 'OPTIONS'],
                'Codigo Estado': ['404', '403', '500', '503'],
                'Navegador': ['Chrome', 'Edge', 'Firefox', 'Safari', 'Opera', 'Internet Explorer']
            };
            categorias_selecionadas = agruparPorCategoria(categorias_access, categoriasSeleccionadas)
        } else if (select_categoria === 'apache_error') {
            const categorias_error = {
                'Nivel': ['emerg', 'alert', 'crit', 'error', 'warn', 'notice', 'info', 'debug', 'access_compat'],
                'Modulo': ['core', 'ssl', 'authz_core', 'rewrite', 'php7', 'php8', 'mpm_prefork', 'proxy']
            };
            categorias_selecionadas = agruparPorCategoria(categorias_error, categoriasSeleccionadas)
        } else if (select_categoria === 'ftp') {
            const categorias_ftp = {
                'Tipo accion': ['FTP command', 'FTP response', 'FAIL LOGIN', 'CONNECTED', 'OK LOGIN', 'FAIL DOWNLOAD', 'DENIED'],
            };
            categorias_selecionadas = agruparPorCategoria(categorias_ftp, categoriasSeleccionadas)
        }
        // Construir el objeto de datos
        const filtros = {
            select_categoria,
            fecha,
            fechaInicio,
            fechaFin,
            hora,
            categorias_selecionadas
        };

        // Mostrar en consola (o puedes enviar al backend)
        console.log(filtros);

        // Ejemplo de envío al backend con fetch
        fetch('/api/filtros', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ categorias_selecionadas })
        })
            .then(res => res.json())
            .then(data => {
                const logs = data.datos_filtrados;
                const header = document.getElementById("tabla-header");
                const body = document.getElementById("tabla-body");

                // Limpiar anteriores
                header.innerHTML = "";
                body.innerHTML = "";

                if (logs.length > 0) {
                    // Crear encabezado
                    Object.keys(logs[0]).forEach(col => {
                        const th = document.createElement("th");
                        th.className = "px-3 py-2";
                        th.textContent = col;
                        header.appendChild(th);
                    });

                    // Crear filas
                    logs.forEach(log => {
                        const tr = document.createElement("tr");
                        tr.className = "bg-white border-b hover:bg-gray-50";

                        Object.values(log).forEach(item => {
                            const td = document.createElement("td");
                            td.className = "px-3 py-2 whitespace-nowrap";
                            td.textContent = item;
                            tr.appendChild(td);
                        });

                        body.appendChild(tr);
                    });
                } else {
                    body.innerHTML = `<tr><td colspan="100%">No se encontraron registros</td></tr>`;
                }
            })
            .catch(err => console.error("Error:", err));
    });
</script>

{% endblock %}